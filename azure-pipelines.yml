# Azure SQL Database Deployment Pipeline - pymssql Version
trigger:
- main

pool:
  name: 'Default'

variables:
  sqlServerName: 'sqlserver-dataops-demo-milan.database.windows.net'
  databaseName: 'db-employees-demo'

stages:
- stage: ValidateAndDeploy
  displayName: 'Validate and Deploy SQL Changes'
  jobs:
  - job: DeploySQL
    displayName: 'Deploy SQL to Azure Database'
    steps:
    
    - checkout: self
      displayName: 'ğŸ“¥ Get SQL files from GitHub'
    
    - script: |
        echo "ğŸ” Validating SQL files..."
        echo "Repository structure:"
        find . -name "*.sql" -type f
        echo ""
        echo "ğŸ“„ SQL files found:"
        ls -la sql/
        echo ""
        echo "ğŸ“ Content preview of create_tables.sql:"
        head -15 sql/create_tables.sql
      displayName: 'ğŸ” Validate SQL Files'
    
    - script: |
        echo "ğŸ“¦ Installing Python packages for SQL Server..."
        
        # Install required Python packages (pymssql instead of pyodbc)
        pip3 install pymssql sqlalchemy pandas
        
        echo "âœ… Python packages installed successfully"
      displayName: 'ğŸ“¦ Install Python SQL Dependencies'
    
    - script: |
        echo "ğŸ”— Testing connection to Azure SQL Database..."
        
        python3 << 'EOF'
        import pymssql
        import sys
        
        # Connection parameters
        server = '$(sqlServerName)'
        database = '$(databaseName)'
        username = '$(sqlUsername)'
        password = '$(sqlPassword)'
        
        try:
            print(f"Connecting to server: {server}")
            print(f"Database: {database}")
            print(f"Username: {username}")
            
            # Test connection
            conn = pymssql.connect(
                server=server,
                user=username,
                password=password,
                database=database,
                timeout=30,
                login_timeout=30
            )
            
            cursor = conn.cursor()
            
            # Test query
            cursor.execute("SELECT GETDATE() as CurrentTime, @@VERSION as SQLVersion")
            row = cursor.fetchone()
            print(f"âœ… Connection successful!")
            print(f"Current time: {row[0]}")
            print(f"SQL Server version: {row[1][:50]}...")
            
            conn.close()
            
        except Exception as e:
            print(f"âŒ Connection failed: {str(e)}")
            sys.exit(1)
        EOF
        
        echo "âœ… Database connection test completed"
      displayName: 'ğŸ”— Test Database Connection'
    
    - script: |
        echo "ğŸš€ Executing SQL deployment script..."
        
        python3 << 'EOF'
        import pymssql
        import sys
        import re
        
        # Connection parameters
        server = '$(sqlServerName)'
        database = '$(databaseName)'
        username = '$(sqlUsername)'
        password = '$(sqlPassword)'
        
        try:
            # Read SQL file
            with open('sql/create_tables.sql', 'r') as file:
                sql_script = file.read()
            
            # Replace database name placeholder
            sql_script = sql_script.replace('USE [your-database-name];', f'USE [{database}];')
            
            print("ğŸ“„ SQL Script to execute:")
            print("-" * 50)
            print(sql_script[:800] + "..." if len(sql_script) > 800 else sql_script)
            print("-" * 50)
            
            # Connect and execute
            conn = pymssql.connect(
                server=server,
                user=username,
                password=password,
                database=database,
                timeout=30,
                login_timeout=30
            )
            
            cursor = conn.cursor()
            
            # Split script by GO statements and execute each batch
            batches = re.split(r'\bGO\b', sql_script, flags=re.IGNORECASE)
            
            for i, batch in enumerate(batches):
                batch = batch.strip()
                if batch and not batch.upper().startswith('USE'):  # Skip USE statements
                    print(f"Executing batch {i+1}...")
                    try:
                        cursor.execute(batch)
                        conn.commit()
                        print(f"âœ… Batch {i+1} executed successfully")
                    except Exception as batch_error:
                        print(f"âš ï¸ Batch {i+1} warning: {str(batch_error)}")
                        # Continue with other batches
            
            conn.close()
            print("âœ… SQL script execution completed!")
            
        except Exception as e:
            print(f"âŒ SQL execution failed: {str(e)}")
            sys.exit(1)
        EOF
        
        echo "ğŸ‰ SQL deployment completed"
      displayName: 'ğŸš€ Deploy SQL Changes'
    
    - script: |
        echo "âœ… Verifying deployment results..."
        
        python3 << 'EOF'
        import pymssql
        import sys
        
        # Connection parameters
        server = '$(sqlServerName)'
        database = '$(databaseName)'
        username = '$(sqlUsername)'
        password = '$(sqlPassword)'
        
        try:
            conn = pymssql.connect(
                server=server,
                user=username,
                password=password,
                database=database,
                timeout=30,
                login_timeout=30
            )
            
            cursor = conn.cursor()
            
            # Check if table exists
            cursor.execute("""
                SELECT COUNT(*) as table_exists 
                FROM INFORMATION_SCHEMA.TABLES 
                WHERE TABLE_NAME = 'employees'
            """)
            
            table_exists = cursor.fetchone()[0]
            
            if table_exists > 0:
                print("âœ… employees table exists!")
                
                # Get record count
                cursor.execute("SELECT COUNT(*) FROM employees")
                count = cursor.fetchone()[0]
                print(f"ğŸ“Š Total records: {count}")
                
                # Show sample data
                cursor.execute("SELECT TOP 3 first_name, last_name, department, hire_date FROM employees")
                rows = cursor.fetchall()
                
                print("ğŸ“‹ Sample data:")
                for row in rows:
                    print(f"  - {row[0]} {row[1]}, {row[2]}, hired: {row[3]}")
                    
            else:
                print("âŒ employees table not found!")
                # Show what tables do exist
                cursor.execute("SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'")
                tables = cursor.fetchall()
                table_names = [table[0] for table in tables]
                print(f"Available tables: {table_names}")
                sys.exit(1)
            
            conn.close()
            
        except Exception as e:
            print(f"âŒ Verification failed: {str(e)}")
            sys.exit(1)
        EOF
        
        echo "ğŸ‰ Deployment verification completed successfully!"
      displayName: 'âœ… Verify Deployment'